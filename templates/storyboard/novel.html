{% extends "storyboard/layout.html" %}
{% load staticfiles %}

{% block title %}
  {{ block.super }}
{% endblock %}

{% block metatags %}
  {{ block.super }}
{% endblock %}

{% block stylesheets %}
  {{ block.super }}
{% endblock %}

{% block javascripts %}
{{ block.super }}
<script>
$(document).on('click','.btn_prev',function(event){
    loadItems($(event.target).attr('value'), 'prev', $(event.target), $(event.target).closest('div').parent());
});
$(document).on('click','.btn_next',function(event){
    loadItems($(event.target).attr('value'), 'next', $(event.target), $(event.target).closest('div').parent());
});

var loadItems = function(ph_id, direction, pwt, par) {

    var url = "/parallelstory/?phid="+ph_id + "&direction=" + direction;
    $.ajax({
        type:"GET",
        url: url, 
        success: function(responseData) {
            var data = JSON.parse(responseData);
            var html = [];
            $.each(data.paragraphs, function(index, paragraph){
                html.push('<div>');
                if(!paragraph.is_parallelfirst)
                    html.push('<a class="btn_prev" value="',paragraph.id, '" index="', paragraph.index ,'">prev</a>');
                html.push('<button name="prev_p" type="submit" value="',paragraph.id,'">new branch</button>');
                if(!paragraph.is_parallellast)
                    html.push('<a class="btn_next" value="',paragraph.id,'" index="',paragraph.index,'">next</a>');
                html.push('<p>',paragraph.text,'</p>');
            });
            console.log(html.join(""));
            var it = pwt.closest('div').parentElement;
            pwt.closest('div').remove();
            $("<div>" + html.join("")+"</div>").appendTo(par);

        },
        error:function(){
        },
        complete: function(data){
        }
    });
};   
</script>
{% endblock %}

{% block contents %}


<div class="row">
    <form class="form-signin" method="post" action="/insert/">
        {% csrf_token %} 
        <div class="col-xs-6 col-xs-offset-3" >
            <h4 style="display:block; text-align: center" >{{novel.title}}</h4>
            {% for paragraph in paragraphs %}
            <div>
                {% if not paragraph.is_parallelfirst %}
                <a class="btn_prev" value="{{paragraph.id}}" index="{{paragraph.index}}">prev</a>
                {% endif %}
                <button name="prev_p" type="submit" value="{{paragraph.id}}">new branch</button>
                {% if not paragraph.is_parallellast %}
                <a class="btn_next" value="{{paragraph.id}}" index="{{paragraph.index}}">next</a>
                {% endif %}
                <p>{{paragraph.text}}</p>
                {% endfor %}
        </div>
    </form>
        </div>
        {% endblock %}

{% block footer %}
{{ block.super }}
{% endblock %}
